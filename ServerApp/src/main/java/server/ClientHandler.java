package server;

import java.io.*;
import java.net.Socket;
import java.net.SocketException;
import java.nio.file.Files;
import java.nio.file.StandardCopyOption;
import java.util.*;
import common.*;
import java.time.DayOfWeek;
import java.time.LocalTime;
import controller.UserController;

public class ClientHandler extends Thread {

    private final Socket socket;
    private ObjectInputStream in;
    private ObjectOutputStream out;

    public ClientHandler(Socket socket) {
        this.socket = socket;
        initReservationData(); // üîπ Ï¥àÍ∏∞Ìôî Ìò∏Ï∂ú
    }

    private void initReservationData() {
        File storageFile = new File("storage/reservation_data.txt");
        if (storageFile.exists()) {
            return;
        }

        try (InputStream is = getClass().getResourceAsStream("/reservation_data.txt")) {
            if (is == null) {
                System.err.println("‚ùå resourcesÏóêÏÑú reservation_data.txt ÌååÏùºÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.");
                return;
            }
            storageFile.getParentFile().mkdirs();
            Files.copy(is, storageFile.toPath(), StandardCopyOption.REPLACE_EXISTING);
            System.out.println("‚úÖ ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å (storage/reservation_data.txt)");
        } catch (IOException e) {
            System.err.println("‚ùå ÏòàÏïΩ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî Ï§ë Ïò§Î•ò Î∞úÏÉù:");
            e.printStackTrace();
        }
    }

    @Override
    public void run() {
        boolean slotAcquired = false;
        try {
            // Ïä§Ìä∏Î¶º Ï¥àÍ∏∞Ìôî
            out = new ObjectOutputStream(socket.getOutputStream());
            out.flush();
            in  = new ObjectInputStream(socket.getInputStream());
            System.out.println("üîµ ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïä§Ìä∏Î¶º Ïó∞Í≤∞Îê®: " + socket.getInetAddress());
            ensureRoomDataInitialized();

            // 3) ÏöîÏ≤≠ Ï≤òÎ¶¨ Î£®ÌîÑ
            while (true) {
                try {
                    Message msg = (Message) in.readObject();
                    System.out.println("‚úÖ ÏàòÏã†Îêú Î©îÏãúÏßÄ: " + msg.getType());

                    Message response = new Message();
                    response.setDomain(msg.getDomain());
                    response.setType(msg.getType());

                    // Î©îÏãúÏßÄ ÌÉÄÏûÖÎ≥Ñ Î∂ÑÍ∏∞ Ï≤òÎ¶¨
                    if (msg.getDomain().equals("user")) {
                        UserController uc = new UserController();
                        Message userResponse = uc.handle(msg);
                        response = userResponse;  // Í∑∏ÎåÄÎ°ú ÏùëÎãµ ÏÇ¨Ïö©
                    } // run() Ïïà Î©îÏãúÏßÄ Î∂ÑÍ∏∞ Ï≤òÎ¶¨ Ï§ëÏóê
                    else if (msg.getType() == RequestType.DISCONNECT) {
                        // ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏Í∞Ä ÏßÅÏ†ë Ïó∞Í≤∞ Ï¢ÖÎ£å ÏùòÏÇ¨Î•º Î∞ùÌûò
                        response.setPayload("DISCONNECTED");
                        out.writeObject(response);
                        out.flush();
                        // break; -> finally Î°ú ÎÑòÏñ¥Í∞ÄÏÑú slot Î∞òÌôò
                        break;
                    } else if (msg.getDomain().equals("user")) {
                         UserController uc = new UserController();
                         Message userResponse = uc.handle(msg);
                         response = userResponse;  // Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                        } 
                        else if (msg.getType() == RequestType.RESERVE) {
                        Reservation r = (Reservation) msg.getPayload();
                        if (isTimeSlotTaken(r)) {
                            response.setPayload("Ï§ëÎ≥µ");
                        } else {
                            saveReservation(r);
                            response.setPayload("ÏÑ±Í≥µ");
                            System.out.println("‚úÖ ÏòàÏïΩ Ï†ÄÏû•Îê®: " + r.getUserName() + " - " + r.getDate() + " " + r.getTime());
                        }
                    } else if (msg.getType() == RequestType.LOAD_TIMETABLE) {
                        @SuppressWarnings("unchecked")
                        java.util.Map<String,String> info = (java.util.Map<String,String>) msg.getPayload();
                        String date = info.get("date");
                        String room = info.get("room");
                        java.util.List<RoomStatus> statusList = loadTimeTable(date, room);
                        response.setPayload(statusList);
                    } else if (msg.getType() == RequestType.LOAD_SCHEDULE_FILE) {
                        String roomNumber = (String) msg.getPayload();
                        java.util.List<String> scheduleLines = loadRoomSchedule(roomNumber);
                        response.setPayload(scheduleLines);
                    } else if (msg.getType() == RequestType.LOAD_MY_RESERVATIONS) {
                        String username = (String) msg.getPayload();
                        java.util.List<Reservation> list = loadReservationsByUserId(username);
                        response.setPayload(list);
                    } else if (msg.getType() == RequestType.LOAD_ALL_RESERVATIONS) {
                        java.util.List<Reservation> all = loadAllReservations();
                        response.setPayload(all);
                    } else if (msg.getType() == RequestType.UPDATE) {
                        @SuppressWarnings("unchecked")
                        java.util.Map<String,String> info = (java.util.Map<String,String>) msg.getPayload();
                        boolean success = updateReservationStatus(info.get("id"), info.get("status"));
                        response.setPayload(success?"OK":"FAIL");
                    } else if (msg.getType() == RequestType.LOAD_ROOMS) {
                        java.util.List<Room> rooms = loadRooms();
                        response.setPayload(rooms);
                    } else if (msg.getType() == RequestType.UPDATE_ROOM_STATUS) {
                        Room updatedRoom = (Room) msg.getPayload();
                        boolean ok = updateRoomStatus(updatedRoom);
                        response.setPayload(ok?"OK":"FAIL");
                    } else if (msg.getType() == RequestType.LOAD_SCHEDULE_ENTRIES) {
                        String roomId = (String) msg.getPayload();
                        java.util.List<ScheduleEntry> entries = loadScheduleEntries(roomId);
                        response.setPayload(entries);
                    } else if (msg.getType() == RequestType.SAVE_SCHEDULE_ENTRY) {
                        try {
                            Object[] arr = (Object[]) msg.getPayload();
                            saveScheduleEntry((String)arr[0], (ScheduleEntry)arr[1]);
                            response.setPayload("OK");
                        } catch (Exception ex) {
                            response.setMessage("ÏùºÏ†ï Ï†ÄÏû• Ï§ë Ïò§Î•ò: " + ex.getMessage());
                            ex.printStackTrace();
                        }
                    } else {
                        response.setMessage("ÏßÄÏõêÌïòÏßÄ ÏïäÎäî ÏöîÏ≤≠ÏûÖÎãàÎã§.");
                    }

                    out.writeObject(response);
                    out.flush();
                } catch (EOFException | SocketException e) {
                    System.out.println("‚ö†Ô∏è ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïó∞Í≤∞ Ï¢ÖÎ£åÎê®: " + socket.getInetAddress());
                    break;
                } catch (Exception e) {
                    System.err.println("‚ùå ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï≤òÎ¶¨ Ï§ë ÏòàÏô∏ Î∞úÏÉù: " + e.getMessage());
                    e.printStackTrace();
                }
            }
        } catch (IOException e) {
            System.err.println("‚ùå ÏÜåÏºì ÏÑ§Ï†ï Ï§ë Ïò§Î•ò: " + e.getMessage());
            e.printStackTrace();
        } finally {
            if (slotAcquired) {
                int left = Server.activeCount.decrementAndGet();
                System.out.println("üîÑ Ïä¨Î°Ø Î∞òÌôò: ÌòÑÏû¨ ÌôúÏÑ± ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ïàò = " + left);
            }
            try {
                if (!socket.isClosed()) socket.close();
            } catch (IOException ignored) {}
        }
    }

    private User findUser(String id, String pw) {
        File file = new File("storage/user.txt");
        if (!file.exists()) {
            return null;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 4) {
                    String fileId = parts[0].trim();
                    String filePw = parts[1].trim();
                    String roleCode = parts[2].trim();
                    String name = parts[3].trim();

                    if (fileId.equals(id) && filePw.equals(pw)) {
                        String role = switch (roleCode) {
                            case "s" ->
                                "ÌïôÏÉù";
                            case "p" ->
                                "ÍµêÏàò";
                            case "a" ->
                                "Ï°∞Íµê";
                            default ->
                                "Ïïå Ïàò ÏóÜÏùå";
                        };
                        return new User(fileId, filePw, role, name);
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return null;
    }

    private boolean checkUserExists(String username) {
        File file = new File("storage/user.txt");
        if (!file.exists()) {
            return false;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 1 && parts[0].trim().equals(username)) {
                    return true;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return false;
    }

    private boolean saveUser(User user) {
        File file = new File("storage/user.txt");
        try {
            file.getParentFile().mkdirs();
            file.createNewFile();

            try (BufferedWriter writer = new BufferedWriter(new FileWriter(file, true))) {
                writer.newLine();
                String line = String.format("%s,%s,%s,%s",
                        user.getUsername(),
                        user.getPassword(),
                        user.getRole(),
                        user.getName());
                writer.write(line);
            }

            return true;
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }

    private boolean isTimeSlotTaken(Reservation r) {
        File file = new File("storage/reservation_data.txt");
        if (!file.exists()) {
            return false;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 5) {
                    String date = parts[0];
                    String time = parts[1];
                    String room = parts[2];
                    String status = parts[4];

                    // ‚ÄúÍ±∞Ï†à‚ÄùÏùÄ ÏòàÏïΩ Î∂àÍ∞Ä Í≤ÄÏÇ¨ÏóêÏÑú Ï†úÏô∏
                    if (date.equals(r.getDate())
                            && time.equals(r.getTime())
                            && room.equals(r.getRoomNumber())
                            && !status.equalsIgnoreCase("Í±∞Ï†à")) {
                        return true;
                    }
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return false;
    }

    private boolean updateReservationStatus(String id, String newStatus) {
        File file = new File("storage/reservation_data.txt");
        List<String> updated = new ArrayList<>();
        boolean found = false;

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            int currentId = 1;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 5) {
                    if (String.valueOf(currentId).equals(id)) {
                        parts[4] = newStatus;
                        found = true;
                    }
                    updated.add(String.join(",", parts));
                    currentId++;
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }

        if (found) {
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(file))) {
                for (String ln : updated) {
                    writer.write(ln + "\n");
                }
                return true;
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return false;
    }

    private boolean updateRoomStatus(Room updatedRoom) {
        File file = new File("storage/rooms.txt");
        List<String> lines = new ArrayList<>();
        boolean updated = false;

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 2 && parts[0].equals(updatedRoom.getRoomId())) {
                    lines.add(updatedRoom.getRoomId() + "," + updatedRoom.getAvailability() + "," + updatedRoom.getCloseReason());
                    updated = true;
                } else {
                    lines.add(line);
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }

        if (updated) {
            try (BufferedWriter writer = new BufferedWriter(new FileWriter(file))) {
                for (String ln : lines) {
                    writer.write(ln + "\n");
                }
                return true;
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        return false;
    }

    private void saveReservation(Reservation r) {
        File file = new File("storage/reservation_data.txt");
        try (BufferedWriter writer = new BufferedWriter(new FileWriter(file, true))) {
            writer.newLine();
            // Î≥ÄÍ≤Ω: r.getUserId() Î°ú ÏïÑÏù¥ÎîîÎ•º Í∫ºÎÇ¥Í≥†, Ïã§Ï†ú Ïù¥Î¶ÑÏùÑ user.txt ÏóêÏÑú Ï∞æÏïÑ ÎÑ£ÏäµÎãàÎã§.
            String userId = r.getUserId();
            String realName = getUserNameById(userId);
            String line = String.format("%s,%s,%s,%s,%s",
                    r.getDate(),
                    r.getTime(),
                    r.getRoomNumber(),
                    // user.txt ÎßàÏßÄÎßâ ÌïÑÎìú(Ïù¥Î¶Ñ)Î•º Í∫ºÎÇ¥ÏÑú
                    realName != null ? realName : userId,
                    r.getStatus()
            );
            writer.write(line);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    private boolean saveScheduleEntry(String roomId, ScheduleEntry entry) {
        File file = new File("storage/schedule_" + roomId + ".txt");
        file.getParentFile().mkdirs();

        try (BufferedWriter writer = new BufferedWriter(new FileWriter(file, true))) {
            writer.write(entry.toTextLine());
            writer.newLine();
            return true;
        } catch (IOException e) {
            e.printStackTrace();
            return false;
        }
    }

    private List<RoomStatus> loadTimeTable(String date, String room) {
        List<RoomStatus> result = new ArrayList<>();

        String[] timeSlots = {
            "09:00~09:50", "10:00~10:50", "11:00~11:50",
            "12:00~12:50", "13:00~13:50", "14:00~14:50",
            "15:00~15:50", "16:00~16:50"
        };

        // ÏãúÍ∞Ñ ‚Üí ÏÉÅÌÉú Îßµ
        Map<String, String> slotStatusMap = new HashMap<>();
        File file = new File("storage/reservation_data.txt");
        if (file.exists()) {
            try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
                String line;
                while ((line = reader.readLine()) != null) {
                    String[] parts = line.split(",");
                    // parts[0]=ÎÇ†Ïßú, parts[1]=ÏãúÍ∞Ñ, parts[2]=Í∞ïÏùòÏã§, parts[4]=ÏÉÅÌÉú
                    if (parts.length >= 5
                            && parts[0].equals(date)
                            && parts[2].equals(room)) {
                        String status = parts[4];
                        // 'Í±∞Ï†à'ÏùÄ ÎπÑÏñ¥ ÏûàÏùåÏúºÎ°ú Ï≤òÎ¶¨ÌïòÍ≥†, Í∑∏ Ïô∏(ÏòàÏïΩ ÎåÄÍ∏∞/ÏòàÏïΩ)Îßå Í∏∞Î°ù
                        if (!"Í±∞Ï†à".equals(status)) {
                            slotStatusMap.put(parts[1], status);
                        }
                    }
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }

        // Í≤∞Í≥º ÏÉùÏÑ±: Ï†ÄÏû•Îêú ÏÉÅÌÉú ÏûàÏúºÎ©¥ Í∑∏ ÏÉÅÌÉú, ÏóÜÏúºÎ©¥ ÎπÑÏñ¥ ÏûàÏùå
        for (String slot : timeSlots) {
            String status = slotStatusMap.getOrDefault(slot, "ÎπÑÏñ¥ ÏûàÏùå");
            result.add(new RoomStatus(slot, status));
        }

        return result;
    }

    private List<String> loadRoomSchedule(String roomNumber) {
        List<String> scheduleList = new ArrayList<>();
        String fileName = "/schedule_" + roomNumber + ".txt";

        try (InputStream is = getClass().getResourceAsStream(fileName); BufferedReader reader = new BufferedReader(new InputStreamReader(is))) {

            String line;
            while ((line = reader.readLine()) != null) {
                scheduleList.add(line);
            }

        } catch (IOException | NullPointerException e) {
            System.err.println("üìõ ÏãúÍ∞ÑÌëú ÌååÏùº ÏùΩÍ∏∞ Ïã§Ìå®: " + fileName);
            e.printStackTrace();
        }

        return scheduleList;
    }

    private List<Reservation> loadReservationsByUserId(String userId) {
        List<Reservation> list = new ArrayList<>();
        String userName = getUserNameById(userId);  // üî∏ IDÎ°ú Ïù¥Î¶Ñ Ï°∞Ìöå
        if (userName == null) {
            System.err.println("‚ùå IDÏóê Ìï¥ÎãπÌïòÎäî Ïù¥Î¶ÑÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§: " + userId);
            return list;
        }

        File file = new File("storage/reservation_data.txt");

        if (!file.exists()) {
            return list;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            int id = 1;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 5 && parts[3].trim().equals(userName.trim())) {
                    list.add(new Reservation(String.valueOf(id++), parts[0], parts[1], parts[2], parts[3], parts[4]));
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return list;
    }

    private List<Reservation> loadAllReservations() {
        List<Reservation> list = new ArrayList<>();
        File file = new File("storage/reservation_data.txt");

        if (!file.exists()) {
            return list;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            int id = 1;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 5) {
                    list.add(new Reservation(String.valueOf(id++), parts[0], parts[1], parts[2], parts[3], parts[4]));
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return list;
    }

    private List<Room> loadRooms() {
        List<Room> list = new ArrayList<>();
        File file = new File("storage/rooms.txt");

        if (!file.exists()) {
            return list;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 2) {
                    Room.Availability avail = switch (parts[1].trim()) {
                        case "OPEN", "ÏÇ¨Ïö©Í∞ÄÎä•" ->
                            Room.Availability.OPEN;
                        case "CLOSED", "ÏÇ¨Ïö©Î∂àÍ∞ÄÎä•" ->
                            Room.Availability.CLOSED;
                        default ->
                            throw new IllegalArgumentException("‚ö†Ô∏è ÏûòÎ™ªÎêú ÏÉÅÌÉú: " + parts[1]);
                    };
                    Room room = new Room(parts[0], avail);
                    if (parts.length >= 3) {
                        room.setCloseReason(parts[2]);
                    }
                    list.add(room);
                }
            }
        } catch (IOException | IllegalArgumentException e) {
            e.printStackTrace();
        }

        return list;
    }

    private List<ScheduleEntry> loadScheduleEntries(String roomId) {
        List<ScheduleEntry> list = new ArrayList<>();
        File file = new File("storage/schedule_" + roomId + ".txt");

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 4) {
                    DayOfWeek day = ScheduleEntry.convertKorDayToEnum(parts[0].trim());
                    String[] times = parts[1].split("~");
                    LocalTime start = LocalTime.parse(times[0].trim());
                    LocalTime end = LocalTime.parse(times[1].trim());
                    String course = parts[2].trim();
                    String prof = parts[3].trim();
                    list.add(new ScheduleEntry(day, start, end, true, "", course, prof));
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return list;
    }

    private String getUserNameById(String userId) {
        File file = new File("storage/user.txt");
        if (!file.exists()) {
            return null;
        }

        try (BufferedReader reader = new BufferedReader(new FileReader(file))) {
            String line;
            while ((line = reader.readLine()) != null) {
                String[] parts = line.split(",");
                if (parts.length >= 4 && parts[0].trim().equals(userId.trim())) {
                    return parts[3].trim();  // ‚úÖ Ïù¥Î¶Ñ Î∞òÌôò
                }
            }
        } catch (IOException e) {
            e.printStackTrace();
        }

        return null;
    }

    private void ensureRoomDataInitialized() {
        File target = new File("storage/rooms.txt");
        if (!target.exists()) {
            try (InputStream is = getClass().getResourceAsStream("/rooms.txt")) {
                if (is == null) {
                    return;
                }
                target.getParentFile().mkdirs();
                try (BufferedReader reader = new BufferedReader(new InputStreamReader(is)); BufferedWriter writer = new BufferedWriter(new FileWriter(target))) {
                    String line;
                    while ((line = reader.readLine()) != null) {
                        writer.write(line);
                        writer.newLine();
                    }
                }
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    private String convertEnumToKorDay(DayOfWeek day) {
        return switch (day) {
            case MONDAY ->
                "Ïõî";
            case TUESDAY ->
                "Ìôî";
            case WEDNESDAY ->
                "Ïàò";
            case THURSDAY ->
                "Î™©";
            case FRIDAY ->
                "Í∏à";
            case SATURDAY ->
                "ÌÜ†";
            case SUNDAY ->
                "Ïùº";
        };
    }

}
